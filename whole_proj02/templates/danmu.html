<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Danmaku</title>
</head>
<body>

<div class="screen_container" id="contents">
</div>

<div class="main">
    <textarea id="danmakutext" type="text" placeholder="Danmaku~"></textarea>
    <button class="send">Send</button>
</div>
<style>
    .screen_container {
        position: relative;
        width: 800px;
        height: 400px;
        margin: 30px auto;
        background: #000;
        overflow: hidden;
        border-style: solid;
        border-radius: 25px;
        border-color: deeppink;
    }

    .main {
        width: 600px;
        margin: 20px auto;
        text-align: center;
    }
</style>
<!-- jQuery -->
<script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script>
<script>
    const timers = [];
    const jqueryDom = createDanmaku('一起来发送弹幕吧');
    addInterval(jqueryDom);

    //initialize GET and POST package
    const get_danmu = new XMLHttpRequest();
    const post_danmu = new XMLHttpRequest();

    //implement polling rule
    setInterval(function () {
        get_danmu.open('GET', 'NEWDANMAKUS/' + new Date().getTime(), true);
        get_danmu.send('stock in');
    }, 1000);

    //show gotten danmu in screen
    get_danmu.onreadystatechange = function () {
        let list
        if (get_danmu.readyState == 4 && get_danmu.status == 200) {
            const danmu_text = get_danmu.responseText;
            list = danmu_text.toString().split('|');
            for (const word of list) {
                if (word !== '') {
                    const danmu = createDanmaku(word)
                    addInterval(danmu)
                }
            }
        }
    };

    //if click button
    // send a POST package to server and clear the text in danmu textarea
    $(".send").on("click", function () {
        //use a sequence of messy text to suggest the end of danmu text
        const message = $("#danmakutext").val() + ' ' +
            new Date().getTime() + ' \n' +
            'Jgtl)2lL1q(D@iIW2r \n';
        $("#danmakutext").val('');
        post_danmu.open('POST', 'NEWDANMAKUS', true);
        post_danmu.send(message);
    });

    // create a Dom object corresponding to a danmaku
    function createDanmaku(text) {
        const jqueryDom = $("<div class='bullet'>" + text + "</div>");
        const fontColor = "rgb(255,255,255)";
        const fontSize = "20px";
        let top = Math.floor(Math.random() * 400) + "px";
        const left = $(".screen_container").width() + "px";
        jqueryDom.css({
            "position": 'absolute',
            "color": fontColor,
            "font-size": fontSize,
            "left": left,
            "top": top,
        });
        $(".screen_container").append(jqueryDom);
        return jqueryDom;
    }

    // add timer task to let the danmaku fly from right to left
    function addInterval(jqueryDom) {
        let left = jqueryDom.offset().left - $(".screen_container").offset().left;
        const timer = setInterval(function () {
            left--;
            jqueryDom.css("left", left + "px");
            if (jqueryDom.offset().left + jqueryDom.width() < $(".screen_container").offset().left) {
                jqueryDom.remove();
                clearInterval(timer);
            }
        }, 5); // set delay as 5ms,which means the danmaku changes its position every 5ms
        timers.push(timer);
    }
</script>
</body>

</html>